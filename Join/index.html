<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Game - Chirpss</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { background-color: #1C2A39; color: #F5F1E6; font-family: sans-serif; }
        .pin-input {
            letter-spacing: 0.5em;
            text-align: center;
            font-family: monospace;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6">
    
    <div class="w-full max-w-md bg-white/5 p-8 rounded-2xl shadow-xl text-center">
        <h1 class="text-3xl font-bold text-fiery-core mb-2">Join Game</h1>
        <p class="text-subtle-gray mb-8">Enter the 4-letter room code</p>

        <input type="text" id="game-code" maxlength="4" placeholder="ABCD" 
               class="pin-input w-full bg-deep-twilight border-2 border-subtle-gray rounded-xl py-4 text-3xl text-white focus:border-fiery-core focus:outline-none mb-6">
        
        <button onclick="joinGame()" id="join-btn" class="w-full py-4 bg-fiery-core text-deep-twilight font-bold text-xl rounded-xl">
            Join
        </button>
        
        <p id="error-msg" class="text-red-400 mt-4 hidden">Game not found</p>
    </div>

    <script>
        // Import config from parent or define here
        const firebaseConfig = {
            apiKey: "AIzaSyAdgoyDsUteoRBIQ74NXvg5Xfj8V105Dnw",
            authDomain: "chirpssgames.firebaseapp.com",
            databaseURL: "https://chirpssgames-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chirpssgames",
            storageBucket: "chirpssgames.firebasestorage.app",
            messagingSenderId: "949878456642",
            appId: "1:949878456642:web:4287fe5fe9577ce1b688db",
            measurementId: "G-E628QMNRQY"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Check if code is in URL (?code=ABCD)
        const urlParams = new URLSearchParams(window.location.search);
        const urlCode = urlParams.get('code');
        if (urlCode) {
            document.getElementById('game-code').value = urlCode;
            joinGame();
        }

        async function joinGame() {
            const codeInput = document.getElementById('game-code');
            const code = codeInput.value.toUpperCase();
            const errorMsg = document.getElementById('error-msg');
            const btn = document.getElementById('join-btn');

            if (code.length < 4) return;

            btn.textContent = "Searching...";
            btn.disabled = true;
            errorMsg.classList.add('hidden');

            try {
                const snapshot = await db.ref('games/' + code).once('value');
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    const gameType = gameData.gameType;

                    // ROUTING LOGIC
                    if (gameType === 'whoami') {
                        window.location.href = `/WhoAmI/Game.html?mode=joiner&code=${code}`;
                    } else if (gameType === 'tenbut') {
                        // Future proofing for 10 But
                        window.location.href = `/TenBut/Game.html?mode=joiner&code=${code}`;
                    } else {
                        // Default fallback
                        window.location.href = `/WhoAmI/Game.html?mode=joiner&code=${code}`;
                    }
                } else {
                    errorMsg.textContent = "Game code not found";
                    errorMsg.classList.remove('hidden');
                    btn.textContent = "Join";
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                errorMsg.textContent = "Connection error";
                errorMsg.classList.remove('hidden');
                btn.textContent = "Join";
                btn.disabled = false;
            }
        }
        
        // Auto-uppercase input
        document.getElementById('game-code').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    </script>
</body>
</html>


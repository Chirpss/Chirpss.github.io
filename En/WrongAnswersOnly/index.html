<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://chirpss.github.io/Cookies.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>CHIRPSS | Wrong Answers Only - Setup</title>
    <link rel="icon" type="image/x-icon" href="/logo.ico">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display.swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    </script>
    <script>
        // Custom Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-twilight': '#1C2A39',
                        'warm-dusk': '#E87040',
                        'fiery-core': '#FFC35B',
                        'soft-horizon': '#F5F1E6',
                        'subtle-gray': '#5A6F82',
                        'input-bg': '#2A3C50',
                        'success-green': '#38A169', /* New primary color for this game */
                        'danger-red': '#E53E3E', /* Added for error messages */
                    },
                    boxShadow: {
                        'input-focus': '0 0 0 3px rgba(56, 161, 105, 0.4)', // Green focus ring
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1C2A39;
            color: #F5F1E6;
        }
        .custom-input {
            background-color: #2A3C50; 
            color: #F5F1E6;
            border: 1px solid #5A6F82;
            transition: all 0.2s;
        }
        .custom-input:focus {
            border-color: #E87040; /* warm-dusk */
            outline: none;
        }
        /* Style adjustments for the main action color (green) */
        .primary-action-bg {
            background-color: #E87040; /* warm-dusk */
            color: #1C2A39;
        }
        
        /* Custom Range Slider Thumb */
        input[type=range]::-webkit-slider-thumb {
            background: #E87040; /* warm-dusk */
        }
    </style>
</head>
<body class="min-h-screen antialiased">
    
    <header class="bg-deep-twilight border-b border-subtle-gray/30 p-4 sticky top-0 z-10 flex-none">
        <div class="max-w-7xl mx-auto flex justify-between items-center w-full">
            <a href="https://chirpss.github.io" class="hover:opacity-90 transition-opacity flex-shrink-0">
                <h1 class="hidden sm:block text-2xl font-bold text-fiery-core/90">CHIRPSS Game hub</h1>
                <h1 class="sm:hidden text-2xl font-bold text-fiery-core/90">CHIRPSS</h1>
            </a>
            
            <div class="flex items-center gap-2">
                </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 sm:p-8">
        <div class="text-center mb-10">
            <h2 class="text-4xl font-extrabold text-soft-horizon mb-2">Wrong Answers Only</h2>
            <p class="text-lg text-subtle-gray">Answer the prompt with a wrong answer before time runs out!</p>
        </div>

        <div class="bg-deep-twilight/50 p-6 sm:p-8 rounded-xl shadow-2xl border border-subtle-gray/30">
            <form id="wao-settings-form">
                
                <div class="mb-8">
                    <label for="player-input" class="block text-lg font-semibold mb-2 text-fiery-core">Add Players</label>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="player-input" placeholder="Enter player name" 
                            class="custom-input flex-grow p-3 rounded-lg placeholder-subtle-gray/70" onkeydown="handlePlayerInput(event)">
                        <button type="button" onclick="addPlayer()" class="primary-action-bg text-deep-twilight p-3 rounded-lg font-semibold">
                            + Add
                        </button>
                    </div>
                    <div id="player-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                        <p class="text-sm text-subtle-gray" id="player-list-placeholder">Add at least 2 players to begin.</p>
                    </div>
                    <p class="text-xs text-subtle-gray mt-1" id="player-count-display">Players: 0 (Min 2)</p>
                </div>

                <div class="grid grid-cols-1 gap-6 mb-8">
                    
                    <div>
                        <label for="question-time-slider" class="block text-lg font-semibold mb-2 text-fiery-core">
                            Time per Question: <span id="question-time-display">10 Seconds</span>
                        </label>
                        <input type="range" id="question-time-slider" min="5" max="30" value="10" step="5"
                               class="w-full h-2 bg-input-bg rounded-lg appearance-none cursor-pointer"
                               oninput="updateQuestionTimeDisplay(this.value)">
                    </div>
                </div>

                <div class="mb-10">
                    <label class="block text-lg font-semibold mb-3 text-fiery-core">Select Prompt Categories</label>
                    <div id="categories-container" class="flex flex-wrap gap-3">
                        </div>
                    <p class="text-xs text-subtle-gray mt-2" id="category-count-message">Select one or more categories.</p>
                </div>

                <button type="submit" id="start-game-btn" class="w-full py-4 bg-subtle-gray text-soft-horizon font-extrabold text-xl rounded-xl shadow-lg" disabled>
                    START GAME
                </button>

            </form>
        </div>
    </main>

    <script>
        // === REMOVED: EMBEDDED CATEGORY DATA ===
        // Data will now be fetched from the URL.

        const GLOBAL_STORAGE_KEY = 'chirpss_wao_data'; // Unique key for this game's persistence
        const CATEGORY_URL = 'https://chirpss.github.io/En/WrongAnswersOnly/Question-Free.json';

        let players = [];
        let selectedCategories = [];
        let availableCategories = []; // This will be populated by the fetch
        let timePerQuestion = 10;

        // --- Persistent Storage Functions (Consolidated) ---

        function loadGlobalData() {
            const data = localStorage.getItem(GLOBAL_STORAGE_KEY);
            const globalData = data ? JSON.parse(data) : {};
            
            // Populate module variables
            players = globalData.players || [];
            selectedCategories = globalData.selectedCategories || [];
            timePerQuestion = globalData.timePerQuestion || 10;
            
            return globalData;
        }

        function saveGlobalData(settings = {}) {
            const dataToSave = {
                players: players,
                selectedCategories: selectedCategories,
                timePerQuestion: settings.timePerQuestion || timePerQuestion,
            };
            localStorage.setItem(GLOBAL_STORAGE_KEY, JSON.stringify(dataToSave));
        }

        // --- Setup Logic ---

        function updatePlayerCount() {
            const count = players.length;
            const catCount = selectedCategories.length;
            
            document.getElementById('player-count-display').textContent = `Players: ${count} (Min 2)`;
            
            // *** CHANGED: Use availableCategories.length instead of the old constant ***
            document.getElementById('category-count-message').textContent = `Selected: ${catCount} of ${availableCategories.length || 0} categories.`;
            
            const startBtn = document.getElementById('start-game-btn');
            const isReady = count >= 2 && catCount > 0;
            startBtn.disabled = !isReady;

            if (isReady) {
                startBtn.classList.remove('bg-subtle-gray');
                startBtn.classList.add('primary-action-bg');
            } else {
                startBtn.classList.add('bg-subtle-gray');
                startBtn.classList.remove('primary-action-bg');
            }
            
            // Save settings whenever player/category state changes
            timePerQuestion = parseInt(document.getElementById('question-time-slider').value);
            saveGlobalData({ timePerQuestion });
        }

        function updateQuestionTimeDisplay(secondsString) {
            timePerQuestion = parseInt(secondsString);
            document.getElementById('question-time-display').textContent = `${timePerQuestion} Seconds`;
            updatePlayerCount(); 
        }
        
        function renderPlayers() {
            const listEl = document.getElementById('player-list');
            listEl.innerHTML = '';

            // *** NEW: Add placeholder if no players ***
            if (players.length === 0) {
                 listEl.innerHTML = `<p class="text-sm text-subtle-gray" id="player-list-placeholder">Add at least 2 players to begin.</p>`;
            }

            players.forEach((name) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'flex justify-between items-center p-2 bg-input-bg rounded-md border border-subtle-gray/50';
                playerEl.innerHTML = `
                    <span>${name}</span>
                    <button type="button" onclick="removePlayer('${name}')" class="text-subtle-gray text-lg font-bold leading-none">
                        &times;
                    </button>
                `;
                listEl.appendChild(playerEl);
            });
            updatePlayerCount();
            saveGlobalData(); 
        }

        function addPlayer() {
            const input = document.getElementById('player-input');
            let name = input.value.trim();
            
            if (name && !players.includes(name)) {
                if (name.length > 20) {
                    name = name.substring(0, 20) + '...'; 
                }
                players.push(name);
                input.value = '';
                renderPlayers();
                document.getElementById('player-list').scrollTop = document.getElementById('player-list').scrollHeight;
            }
        }

        function removePlayer(nameToRemove) {
            players = players.filter(name => name !== nameToRemove);
            renderPlayers();
        }

        function handlePlayerInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addPlayer();
            }
        }
        
        // *** NEW: Async function to fetch and render categories ***
        async function fetchAndRenderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = `<p class="text-fiery-core">Loading categories...</p>`;

            try {
                const response = await fetch(CATEGORY_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                if (!data || !data.c) {
                     throw new Error("Invalid JSON structure.");
                }

                availableCategories = data.c; // Populate the global variable

                renderCategories(); // Now call render
                updatePlayerCount(); // And update the count display

            } catch (error) {
                console.error("Failed to load categories:", error);
                container.innerHTML = `<p class="text-danger-red font-semibold">Error: Could not load question categories. Please try refreshing.</p>`;
                // Disable start button as categories failed
                document.getElementById('start-game-btn').disabled = true;
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = ''; 

            if (!availableCategories || availableCategories.length === 0) {
                // This case is now handled by the fetch function's error state
                container.innerHTML = `<p class="text-danger-red font-semibold">Error: No categories found.</p>`;
                return;
            }

            availableCategories.forEach(category => {
                const categoryName = category.n; 
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn bg-input-bg text-soft-horizon py-2 px-4 rounded-full border border-subtle-gray/50';
                button.textContent = categoryName;
                
                button.onclick = () => toggleCategory(button, categoryName);
                
                // Apply persistence coloring/selection during rendering
                if (selectedCategories.includes(categoryName)) {
                    button.classList.add('primary-action-bg', 'text-deep-twilight', 'border-warm-dusk');
                    button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
                }
                
                container.appendChild(button);
            });
            // Note: updatePlayerCount() is called by the fetch function AFTER renderCategories() completes
        }

        function toggleCategory(button, categoryName) {
            const index = selectedCategories.indexOf(categoryName);
            if (index > -1) {
                // Deselect
                selectedCategories.splice(index, 1);
                button.classList.remove('primary-action-bg', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.add('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            } else {
                // Select
                selectedCategories.push(categoryName);
                button.classList.add('primary-action-bg', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            }
            updatePlayerCount(); 
        }

        function initializeSettings(globalData) {
            // 1. Time Slider
            const timeSlider = document.getElementById('question-time-slider');
            timeSlider.value = globalData.timePerQuestion || 10;
            updateQuestionTimeDisplay(timeSlider.value); 
            timeSlider.oninput = (e) => updateQuestionTimeDisplay(e.target.value);
        }

        // --- Initialization and Submit ---
        document.addEventListener('DOMContentLoaded', () => {
            const globalData = loadGlobalData();
            
            initializeSettings(globalData); 
            
            // *** CHANGED: Call the fetch function instead of load/render directly ***
            fetchAndRenderCategories(); 
            
            renderPlayers(); // This is independent and can run
        });

        document.getElementById('wao-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (players.length < 2) {
                alert("Please add a minimum of 2 players.");
                return;
            }
            if (selectedCategories.length === 0) {
                alert("Please select at least one prompt category.");
                return;
            }

            // --- Capture FINAL Settings ---
            const finalTime = parseInt(document.getElementById('question-time-slider').value);
            
            const finalSettings = {
                timePerQuestion: finalTime,
                selectedCategories: selectedCategories
            };
            
            // 1. Save all data (players and settings) for next load
            saveGlobalData(finalSettings);

            // 2. Prepare Game Data for Session
            // *** This logic remains the same, as availableCategories is populated by the fetch ***
            const finalPrompts = availableCategories
                .filter(cat => selectedCategories.includes(cat.n))
                .map(cat => cat.p) // Only pull the array of prompts (p)
                .flat(); // Flatten the array of arrays into one list of prompts
            
            // *** NEW: Add a check in case fetch failed and user somehow clicked submit ***
            if (finalPrompts.length === 0) {
                 alert("Error: No prompts were loaded from the selected categories. Cannot start game.");
                 return;
            }
            
            const gameData = {
                players: players,
                timePerQuestion: finalTime,
                prompts: finalPrompts 
            };

            // 3. Store data in SESSION STORAGE (for the current game session)
            sessionStorage.setItem('wao_game_data', JSON.stringify(gameData));

            // 4. Redirect
            // NOTE: The game is assumed to be at a relative path like '/WrongAnswersOnly/Game'
            window.location.href = '/WrongAnswersOnly/Game.html';
        });
    </script>
</body>
</html>

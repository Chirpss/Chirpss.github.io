<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://chirpss.github.io/Cookies.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>CHIRPSS | Who Am I? - Setup</title>
    <link rel="icon" type="image/x-icon" href="/logo.ico">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script src="/WhoAmI/firebase-config.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-twilight': '#1C2A39',
                        'warm-dusk': '#E87040',
                        'fiery-core': '#FFC35B',
                        'soft-horizon': '#F5F1E6',
                        'subtle-gray': '#5A6F82',
                        'input-bg': '#2A3C50',
                        'danger-red': '#E53E3E',
                    },
                    boxShadow: {
                        'input-focus': '0 0 0 3px rgba(255, 195, 91, 0.4)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1C2A39;
            color: #F5F1E6;
        }
        .category-btn { transition: all 0.2s ease-in-out; }
        .mode-btn { transition: all 0.3s ease; }

        /* Styling for details/summary to match theme */
        details > summary {
            list-style: none; /* Remove default marker */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Remove default marker (Safari) */
        }
        /* Custom marker */
        details > summary::before {
            content: 'â–º';
            display: inline-block;
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="min-h-screen antialiased flex flex-col">

    <header class="bg-deep-twilight border-b border-subtle-gray/30 p-4 sticky top-0 z-10 flex-none">
        <div class="max-w-7xl mx-auto flex justify-between items-center w-full">
            <a href="https://chirpss.my.to" class="hover:opacity-90 transition-opacity flex-shrink-0">
                <h1 class="hidden sm:block text-2xl font-bold text-fiery-core/90">CHIRPSS Game hub</h1>
                <h1 class="sm:hidden text-2xl font-bold text-fiery-core/90">CHIRPSS</h1>
            </a>
            
            <div class="flex items-center gap-4">
                <div class="flex bg-input-bg rounded-lg border border-subtle-gray/50 overflow-hidden">
                    <button onclick="setLanguage('EN')" id="lang-en" class="px-3 py-1 text-sm font-bold transition-colors text-subtle-gray hover:text-soft-horizon">EN</button>
                    <div class="w-px bg-subtle-gray/50"></div>
                    <button onclick="setLanguage('DE')" id="lang-de" class="px-3 py-1 text-sm font-bold transition-colors text-subtle-gray hover:text-soft-horizon">DE</button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 sm:p-8 flex-grow w-full">
        <div class="text-center mb-10">
            <h2 class="text-4xl font-extrabold text-soft-horizon mb-2">Who Am I?</h2>
        </div>

        <div class="bg-deep-twilight/50 p-6 sm:p-8 rounded-xl shadow-2xl border border-subtle-gray/30">
            
            <div class="mb-8">
                <label class="block text-lg font-semibold mb-3 text-fiery-core">Game Mode</label>
                <div class="flex space-x-4 bg-input-bg p-2 rounded-xl border border-subtle-gray/50">
                    <button onclick="setMode('single')" id="mode-single" class="mode-btn flex-1 py-3 rounded-lg font-bold text-soft-horizon hover:bg-subtle-gray/30">
                        Single Device
                    </button>
                    <button onclick="setMode('multi')" id="mode-multi" class="mode-btn flex-1 py-3 rounded-lg font-bold text-soft-horizon hover:bg-subtle-gray/30">
                        Multi Device
                    </button>
                </div>
            </div>

            <div class="mb-10">
                <details id="category-section" class="rounded-lg border border-subtle-gray/30 overflow-hidden" open>
                    <summary class="block text-lg font-semibold p-4 text-fiery-core bg-input-bg cursor-pointer select-none">
                        Select Word Decks
                    </summary>
                    <div class="p-4 pt-3 border-t border-subtle-gray/30">
                        <div id="categories-container" class="flex flex-wrap gap-3">
                            <p class="text-subtle-gray animate-pulse">Loading categories...</p>
                        </div>
                        <p class="text-xs text-subtle-gray mt-2" id="category-count-message">Select one or more categories.</p>
                    </div>
                </details>
            </div>

            <button id="start-btn" onclick="initGame()" class="w-full py-4 bg-subtle-gray text-soft-horizon font-extrabold text-xl rounded-xl shadow-lg transition-all transform active:scale-95" disabled>
                Pick a Category
            </button>

        </div>
    </main>

    <script>
        let allCategories = [];
        let selectedCategories = [];
        let gameMode = 'single';
        let db;
        // Default to EN if no cookie found
        let currentLang = 'EN'; 

        // Helper to get cookie by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Helper to set cookie
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        function setLanguage(lang) {
            setCookie('chirpss_lang', lang, 365);
            // Reload to fetch new data
            window.location.reload(); 
        }

        function updateLangUI() {
            const btnEn = document.getElementById('lang-en');
            const btnDe = document.getElementById('lang-de');
            const activeClass = "bg-warm-dusk text-deep-twilight";
            const inactiveClass = "text-subtle-gray hover:text-soft-horizon bg-transparent";

            // Reset
            btnEn.className = `px-3 py-1 text-sm font-bold transition-colors ${inactiveClass}`;
            btnDe.className = `px-3 py-1 text-sm font-bold transition-colors ${inactiveClass}`;

            if(currentLang === 'DE') {
                btnDe.className = `px-3 py-1 text-sm font-bold transition-colors ${activeClass}`;
            } else {
                btnEn.className = `px-3 py-1 text-sm font-bold transition-colors ${activeClass}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Check Language Cookie
            const savedLang = getCookie('chirpss_lang');
            if(savedLang) currentLang = savedLang;
            updateLangUI();

            // 2. Determine File
            const dataFile = currentLang === 'DE' ? 'dataDE.json' : 'data.json';

            // 3. Connect Database
            if (typeof firebase !== 'undefined') {
                try {
                    db = firebase.database();
                    console.log("Firebase initialized successfully");
                } catch (e) {
                    console.log("Firebase error:", e);
                }
            } else {
                console.log("Firebase SDK not found");
            }
            
            setMode('single');

            // 4. Fetch Correct Data
            fetch(dataFile)
                .then(res => res.json())
                .then(data => {
                    allCategories = data.categories;
                    renderCategories();
                })
                .catch(err => {
                    document.getElementById('categories-container').innerHTML = `<p class="text-danger-red">Error loading ${dataFile}</p>`;
                });
        });

        function setMode(mode) {
            gameMode = mode;
            const singleBtn = document.getElementById('mode-single');
            const multiBtn = document.getElementById('mode-multi');

            const baseClass = "mode-btn flex-1 py-3 rounded-lg font-bold text-soft-horizon hover:bg-subtle-gray/30";
            const activeClass = "mode-btn flex-1 py-3 rounded-lg font-bold text-deep-twilight bg-warm-dusk shadow-lg";

            if (mode === 'single') {
                singleBtn.className = activeClass;
                multiBtn.className = baseClass;
            } else {
                singleBtn.className = baseClass;
                multiBtn.className = activeClass;
            }
            updateStartButton();
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            
            allCategories.forEach(cat => {
                const btn = document.createElement('button');
                // Updated Pill Style to match Imposter
                btn.className = 'category-btn bg-input-bg text-soft-horizon py-2 px-4 rounded-full border border-subtle-gray/50 font-medium hover:border-fiery-core';
                btn.textContent = cat.name;
                btn.dataset.name = cat.name;
                
                btn.onclick = () => toggleCategory(cat.name, btn);
                container.appendChild(btn);
            });
        }

        function toggleCategory(name, btn) {
            if (selectedCategories.includes(name)) {
                // Deselect
                selectedCategories = selectedCategories.filter(c => c !== name);
                btn.classList.remove('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk', 'font-bold');
                btn.classList.add('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50', 'font-medium');
            } else {
                // Select
                selectedCategories.push(name);
                btn.classList.add('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk', 'font-bold');
                btn.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50', 'font-medium');
            }
            updateStartButton();
        }

        function updateStartButton() {
            const btn = document.getElementById('start-btn');
            // Update message
            const count = selectedCategories.length;
            const total = allCategories.length;
            document.getElementById('category-count-message').textContent = `Selected: ${count} of ${total} categories.`;

            if (count > 0) {
                btn.disabled = false;
                btn.classList.remove('bg-subtle-gray', 'text-soft-horizon');
                btn.classList.add('bg-fiery-core', 'text-deep-twilight');
                btn.textContent = gameMode === 'single' ? "Start Game" : "Create Room";
            } else {
                btn.disabled = true;
                btn.classList.add('bg-subtle-gray', 'text-soft-horizon');
                btn.classList.remove('bg-fiery-core', 'text-deep-twilight');
                btn.textContent = "Pick a Category";
            }
        }

        async function initGame() {
            let gameWords = [];
            allCategories.forEach(cat => {
                if (selectedCategories.includes(cat.name)) {
                    gameWords.push(...cat.words);
                }
            });
            gameWords.sort(() => Math.random() - 0.5);

            if (gameMode === 'single') {
                sessionStorage.setItem('whoami_data', JSON.stringify(gameWords));
                window.location.href = 'Game.html?mode=single';
            } else {
                if (!db) {
                    alert("Database not connected. Check config.");
                    return;
                }
                const code = generateCode();
                const roomRef = db.ref('games/' + code);
                
                await roomRef.set({
                    gameType: 'whoami',
                    status: 'lobby',
                    categories: selectedCategories,
                    wordsPool: gameWords,
                    startTime: 0,
                    players: {} 
                });

                window.location.href = `Game.html?mode=host&code=${code}`;
            }
        }

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Setup - Chirpss</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SV2022ERX5"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

    gtag('config', 'G-SV2022ERX5');
    </script>
    <script>
        // Custom Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-twilight': '#1C2A39',   /* Main Dark Background */
                        'warm-dusk': '#E87040',       /* Primary Action/Button */
                        'fiery-core': '#FFC35B',      /* Accent/Highlight */
                        'soft-horizon': '#F5F1E6',    /* Light Text/Card Background/Input */
                        'subtle-gray': '#5A6F82',     /* Subtler text/border color */
                        'input-bg': '#2A3C50',        /* Slightly lighter background for inputs */
                        'danger-red': '#E53E3E',
                    },
                    boxShadow: {
                        'input-focus': '0 0 0 3px rgba(255, 195, 91, 0.4)', // Focus ring
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1C2A39; /* deep-twilight */
            color: #F5F1E6; /* soft-horizon */
        }
        .custom-input {
            background-color: #2A3C50; 
            color: #F5F1E6;
            border: 1px solid #5A6F82;
            transition: all 0.2s;
        }
        .custom-input:focus {
            border-color: #FFC35B;
            box-shadow: 0 0 0 3px rgba(255, 195, 91, 0.4); 
            outline: none;
        }
        
        /* Fixed Toggle Switch Styling with Smooth Transition */
        .toggle-track {
            background-color: #5A6F82; 
            transition: background-color 0.4s ease;
        }
        .peer:checked + .toggle-track {
            background-color: #E87040; 
        }
        .slider {
            background-color: #F5F1E6; 
            transition: transform 0.4s ease;
        }
        .peer:checked + .toggle-track > .slider {
            transform: translateX(20px); 
        }
        
        /* Custom Range Slider Track (The background track) */
        input[type=range]::-webkit-slider-runnable-track {
            background: #2A3C50;
            height: 8px;
            border-radius: 4px;
        }
        /* Custom Range Slider Thumb (The movable dot) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #FFC35B; /* fiery-core */
            margin-top: -6px;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen antialiased">
    
    <header class="bg-deep-twilight border-b border-subtle-gray/30 p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-fiery-core/90">CHIRPSS</h1>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 sm:p-8">
        <div class="text-center mb-10">
            <h2 class="text-4xl font-extrabold text-soft-horizon mb-2">Imposter</h2>
        </div>

        <div class="bg-deep-twilight/50 p-6 sm:p-8 rounded-xl shadow-2xl border border-subtle-gray/30">
            <form id="imposter-settings-form">
                
                <div class="mb-8">
                    <label for="player-input" class="block text-lg font-semibold mb-2 text-fiery-core">Add Players</label>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="player-input" placeholder="Enter player name" 
                            class="custom-input flex-grow p-3 rounded-lg placeholder-subtle-gray/70" onkeydown="handlePlayerInput(event)">
                        <button type="button" onclick="addPlayer()" class="bg-warm-dusk text-soft-horizon p-3 rounded-lg font-semibold">
                            Add
                        </button>
                    </div>

                    <div id="player-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                        <p class="text-sm text-subtle-gray" id="player-list-placeholder">Add at least 3 players to begin.</p>
                    </div>
                    <p class="text-xs text-subtle-gray mt-1" id="player-count-display">Players: 0 (Min 3)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="imposter-count-slider" class="block text-lg font-semibold mb-2 text-fiery-core">
                            Number of Imposters: <span id="imposter-count-value">1</span>
                        </label>
                        <input type="range" id="imposter-count-slider" min="1" max="5" value="1" 
                               class="w-full h-2 bg-input-bg rounded-lg appearance-none cursor-pointer" 
                               oninput="updateSliderValue('imposter-count-slider', 'imposter-count-value')">
                    </div>

                    <div>
                        <label for="game-time-slider" class="block text-lg font-semibold mb-2 text-fiery-core">
                            Game Time Limit: <span id="game-time-display">5 Minutes</span>
                        </label>
                        <input type="range" id="game-time-slider" min="0.5" max="15" value="5" step="0.5"
                               class="w-full h-2 bg-input-bg rounded-lg appearance-none cursor-pointer"
                               oninput="updateGameTimeDisplay(this.value)">
                    </div>
                </div>

                <div class="mb-8 flex items-center justify-between p-3 bg-input-bg rounded-lg border border-subtle-gray/50">
                    <label for="imposter-hint-toggle" class="block text-lg font-semibold text-fiery-core">
                        Imposter Gets a Hint
                    </label>
                    
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="imposter-hint-toggle" checked class="sr-only peer toggle-switch" onclick="updatePlayerCount()">
                        <div class="w-10 h-5 bg-subtle-gray rounded-full toggle-track">
                            <div class="absolute top-0.5 start-[2px] border border-subtle-gray rounded-full h-4 w-4 bg-soft-horizon slider"></div>
                        </div>
                    </label>
                </div>

                <div class="mb-10">
                    <label class="block text-lg font-semibold mb-3 text-fiery-core">Select Word Categories (Set 1)</label>
                    <div id="categories-container-1" class="flex flex-wrap gap-3">
                        </div>
                    <p class="text-xs text-subtle-gray mt-2" id="category-count-message-1">Select one or more categories.</p>
                </div>

                <div class="mb-10">
                    <label class="block text-lg font-semibold mb-3 text-fiery-core">Select Word Categories (Set 2)</label>
                    <div id="categories-container-2" class="flex flex-wrap gap-3">
                        </div>
                    <p class="text-xs text-subtle-gray mt-2" id="category-count-message-2">Select one or more categories.</p>
                </div>

                <button type="submit" id="start-game-btn" class="w-full py-4 bg-subtle-gray text-soft-horizon font-extrabold text-xl rounded-xl shadow-lg" disabled>
                    START GAME
                </button>
                
                <p class="text-sm text-subtle-gray mt-6"> Rules: Everyone gets a secret word besides one player (the imposter) who only gets a hint. The imposter must guess the word before the time runs out. If the timer ends, everyone votes. If the imposter isn't voted out, they win. Players take turns saying one word related to the secret word until the timer ends. The youngest player goes first.
                </p>

            </form>
        </div>
        
    </main>

    <script>
        // === Define constants for URL and storage keys ===
        const CATEGORY_URL_1 = 'https://chirpss.my.to/Imposter/categories.json';
        const CATEGORY_URL_2 = 'https://chirpss.my.to/Imposter/categories2.json'; // New URL as requested
        const SETTINGS_STORAGE_KEY = 'chirpss_imposter_settings'; 
        const PLAYERS_STORAGE_KEY = 'chirpss_imposter_players';

        let players = [];
        
        // State for list 1
        let selectedCategories_1 = [];
        let availableCategories_1 = [];

        // State for list 2
        let selectedCategories_2 = [];
        let availableCategories_2 = [];

        // --- Persistence Helper Function ---
        function getCurrentSettings() {
            const imposterSlider = document.getElementById('imposter-count-slider');
            const timeSlider = document.getElementById('game-time-slider');
            const hintToggle = document.getElementById('imposter-hint-toggle');

            return {
                imposterCount: imposterSlider ? imposterSlider.value : 1,
                gameTimeMinutes: timeSlider ? parseFloat(timeSlider.value) : 5,
                hintEnabled: hintToggle ? hintToggle.checked : true,
                selectedCategories_1: selectedCategories_1,
                selectedCategories_2: selectedCategories_2
            };
        }

        // --- Persistent Storage Functions ---

        function savePlayersToStorage() {
            localStorage.setItem(PLAYERS_STORAGE_KEY, JSON.stringify(players));
            updatePlayerCount(); 
        }

        function getPlayersFromStorage() {
            const list = localStorage.getItem(PLAYERS_STORAGE_KEY);
            return list ? JSON.parse(list) : [];
        }

        function saveSettingsToStorage(settings) {
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettingsFromStorage() {
            const data = localStorage.getItem(SETTINGS_STORAGE_KEY);
            return data ? JSON.parse(data) : null;
        }

        // --- Setup Logic ---

        function updatePlayerCount() {
            const count = players.length;
            const catCount_1 = selectedCategories_1.length;
            const catCount_2 = selectedCategories_2.length;
            
            document.getElementById('player-count-display').textContent = `Players: ${count} (Min 3)`;
            
            // Update both category count messages
            document.getElementById('category-count-message-1').textContent = `Selected: ${catCount_1} of ${availableCategories_1.length || 0} categories.`;
            document.getElementById('category-count-message-2').textContent = `Selected: ${catCount_2} of ${availableCategories_2.length || 0} categories.`;
            
            const startBtn = document.getElementById('start-game-btn');
            
            // Enable start if 3+ players AND at least one category from EITHER list is selected
            const isReady = count >= 3 && (catCount_1 > 0 || catCount_2 > 0);
            startBtn.disabled = !isReady;

            if (isReady) {
                startBtn.classList.remove('bg-subtle-gray');
                startBtn.classList.add('bg-warm-dusk');
            } else {
                startBtn.classList.add('bg-subtle-gray');
                startBtn.classList.remove('bg-warm-dusk');
            }

            const placeholder = document.getElementById('player-list-placeholder');
            if (placeholder) {
                placeholder.style.display = count === 0 ? 'block' : 'none';
            }
            
            saveSettingsToStorage(getCurrentSettings());
        }

        function updateGameTimeDisplay(minutesString) {
            const timeDisplay = document.getElementById('game-time-display');
            const minutes = parseFloat(minutesString);

            if (minutes === 0.5) {
                timeDisplay.textContent = '30 Seconds';
            } else {
                timeDisplay.textContent = `${minutes} Minutes`;
            }
            updatePlayerCount(); // Triggers settings save
        }
        
        function renderPlayers() {
            const listEl = document.getElementById('player-list');
            listEl.innerHTML = '';
            
            if (players.length === 0) {
                listEl.innerHTML = `<p class="text-sm text-subtle-gray" id="player-list-placeholder">Add at least 3 players to begin.</p>`;
            }
            
            players.forEach((name) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'flex justify-between items-center p-2 bg-input-bg rounded-md border border-subtle-gray/50';
                playerEl.innerHTML = `
                    <span>${name}</span>
                    <button type="button" onclick="removePlayer('${name}')" class="text-subtle-gray text-lg font-bold leading-none">
                        &times;
                    </button>
                `;
                listEl.appendChild(playerEl);
            });
        }

        function addPlayer() {
            const input = document.getElementById('player-input');
            let name = input.value.trim();
            
            if (name && !players.includes(name)) {
                if (name.length > 20) {
                    name = name.substring(0, 20) + '...'; 
                }
                players.push(name);
                input.value = '';
                renderPlayers();
                savePlayersToStorage();
                document.getElementById('player-list').scrollTop = document.getElementById('player-list').scrollHeight;
            }
        }

        function removePlayer(nameToRemove) {
            players = players.filter(name => name !== nameToRemove);
            renderPlayers();
            savePlayersToStorage();
        }

        function handlePlayerInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addPlayer();
            }
        }
        
        function updateSliderValue(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            document.getElementById(valueId).textContent = slider.value;
            updatePlayerCount(); // Triggers settings save
        }

        // --- Category Functions (List 1) ---

        async function fetchAndRenderCategories_1() {
            const container = document.getElementById('categories-container-1');
            container.innerHTML = `<p class="text-fiery-core">Loading categories...</p>`;

            try {
                const response = await fetch(CATEGORY_URL_1);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                if (!data || !data.c) {
                     throw new Error("Invalid JSON structure.");
                }

                availableCategories_1 = data.c;
                renderCategories_1();
                updatePlayerCount();

            } catch (error) {
                console.error("Failed to load categories 1:", error);
                container.innerHTML = `<p class="text-danger-red font-semibold">Error: Could not load categories (Set 1).</p>`;
                updatePlayerCount(); // Still update counts even on error
            }
        }

        function renderCategories_1() {
            const container = document.getElementById('categories-container-1');
            container.innerHTML = ''; 

            if (!availableCategories_1 || availableCategories_1.length === 0) {
                container.innerHTML = `<p class="text-subtle-gray">No categories found for Set 1.</p>`;
                return;
            }

            availableCategories_1.forEach(category => {
                const categoryName = category.n; 
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn bg-input-bg text-soft-horizon py-2 px-4 rounded-full border border-subtle-gray/50';
                button.textContent = categoryName;
                
                button.onclick = () => toggleCategory_1(button, categoryName);
                
                if (selectedCategories_1.includes(categoryName)) {
                    button.classList.add('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                    button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
                }
                
                container.appendChild(button);
            });
        }

        function toggleCategory_1(button, categoryName) {
            const index = selectedCategories_1.indexOf(categoryName);
            if (index > -1) {
                selectedCategories_1.splice(index, 1);
                button.classList.remove('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.add('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            } else {
                selectedCategories_1.push(categoryName);
                button.classList.add('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            }
            updatePlayerCount();
        }

        // --- Category Functions (List 2) ---

        async function fetchAndRenderCategories_2() {
            const container = document.getElementById('categories-container-2');
            container.innerHTML = `<p class="text-fiery-core">Loading categories...</p>`;

            try {
                const response = await fetch(CATEGORY_URL_2);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                if (!data || !data.c) {
                     throw new Error("Invalid JSON structure.");
                }

                availableCategories_2 = data.c;
                renderCategories_2();
                updatePlayerCount();

            } catch (error) {
                console.error("Failed to load categories 2:", error);
                container.innerHTML = `<p class="text-danger-red font-semibold">Error: Could not load categories (Set 2).</p>`;
                updatePlayerCount(); // Still update counts even on error
            }
        }

        function renderCategories_2() {
            const container = document.getElementById('categories-container-2');
            container.innerHTML = ''; 

            if (!availableCategories_2 || availableCategories_2.length === 0) {
                container.innerHTML = `<p class="text-subtle-gray">No categories found for Set 2.</p>`;
                return;
            }

            availableCategories_2.forEach(category => {
                const categoryName = category.n; 
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn bg-input-bg text-soft-horizon py-2 px-4 rounded-full border border-subtle-gray/50';
                button.textContent = categoryName;
                
                button.onclick = () => toggleCategory_2(button, categoryName);
                
                if (selectedCategories_2.includes(categoryName)) {
                    button.classList.add('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                    button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
                }
                
                container.appendChild(button);
            });
        }

        function toggleCategory_2(button, categoryName) {
            const index = selectedCategories_2.indexOf(categoryName);
            if (index > -1) {
                selectedCategories_2.splice(index, 1);
                button.classList.remove('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.add('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            } else {
                selectedCategories_2.push(categoryName);
                button.classList.add('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            }
            updatePlayerCount();
        }

        // --- Initialization and Submit ---

        function initializeSettings() {
            const settings = loadSettingsFromStorage();
            
            // Populate selected categories for both lists
            selectedCategories_1 = settings ? settings.selectedCategories_1 || [] : [];
            selectedCategories_2 = settings ? settings.selectedCategories_2 || [] : [];

            // 1. Imposters Slider
            const imposterSlider = document.getElementById('imposter-count-slider');
            const imposterCount = settings ? settings.imposterCount || 1 : 1;
            imposterSlider.value = imposterCount;
            document.getElementById('imposter-count-value').textContent = imposterCount;
            imposterSlider.oninput = () => updateSliderValue('imposter-count-slider', 'imposter-count-value');

            // 2. Time Slider
            const timeSlider = document.getElementById('game-time-slider');
            const gameTimeMinutes = settings ? settings.gameTimeMinutes || 5 : 5;
            timeSlider.value = gameTimeMinutes;
            updateGameTimeDisplay(timeSlider.value);
            timeSlider.oninput = (e) => updateGameTimeDisplay(e.target.value);

            // 3. Hint Toggle
            const hintEnabled = settings ? settings.hintEnabled !== false : true;
            document.getElementById('imposter-hint-toggle').checked = hintEnabled; 
            document.getElementById('imposter-hint-toggle').onclick = updatePlayerCount;
            
            if (!settings) {
                saveSettingsToStorage(getCurrentSettings());
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load and apply persistent settings
            initializeSettings(); 

            // 2. Load and render players
            players = getPlayersFromStorage();
            renderPlayers();

            // 3. Fetch and render BOTH category lists
            fetchAndRenderCategories_1();
            fetchAndRenderCategories_2();
        });

        document.getElementById('imposter-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (players.length < 3) {
                alert("Please add a minimum of 3 players.");
                return;
            }
            // Check if at least one category is selected from EITHER list
            if (selectedCategories_1.length === 0 && selectedCategories_2.length === 0) {
                alert("Please select at least one word category from either list.");
                return;
            }

            const currentSettings = getCurrentSettings();
            
            saveSettingsToStorage(currentSettings);

            // Prepare Game Data: Combine categories from both lists
            const finalCategories_1 = availableCategories_1
                .filter(cat => selectedCategories_1.includes(cat.n))
                .map(cat => ({ name: cat.n, words: cat.w }));
            
            const finalCategories_2 = availableCategories_2
                .filter(cat => selectedCategories_2.includes(cat.n))
                .map(cat => ({ name: cat.n, words: cat.w }));
            
            const allFinalCategories = finalCategories_1.concat(finalCategories_2);
            
            if (allFinalCategories.length === 0 || allFinalCategories.every(cat => cat.words.length === 0)) {
                alert("Error: No words were loaded from the selected categories. Cannot start game.");
                return;
            }
            
            const gameData = {
                players: players,
                imposterCount: currentSettings.imposterCount,
                gameTimeSeconds: currentSettings.gameTimeMinutes * 60, 
                hintEnabled: currentSettings.hintEnabled,
                categories: allFinalCategories // Use the combined list
            };

            sessionStorage.setItem('chirpss_imposter_game_data', JSON.stringify(gameData));

            window.location.href = '/Imposter/RevealRole';
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Setup - Chirpss</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display.swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

    gtag('config', 'G-SV2022ERX5');
    </script>
    <script>
        // Custom Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-twilight': '#1C2A39',   /* Main Dark Background */
                        'warm-dusk': '#E87040',       /* Primary Action/Button */
                        'fiery-core': '#FFC35B',      /* Accent/Highlight */
                        'soft-horizon': '#F5F1E6',    /* Light Text/Card Background/Input */
                        'subtle-gray': '#5A6F82',     /* Subtler text/border color */
                        'input-bg': '#2A3C50',        /* Slightly lighter background for inputs */
                        'danger-red': '#E53E3E',
                    },
                    boxShadow: {
                        'input-focus': '0 0 0 3px rgba(255, 195, 91, 0.4)', // Focus ring
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1C2A39; /* deep-twilight */
            color: #F5F1E6; /* soft-horizon */
        }
        .custom-input {
            background-color: #2A3C50; 
            color: #F5F1E6;
            border: 1px solid #5A6F82;
            transition: all 0.2s;
        }
        .custom-input:focus {
            border-color: #FFC35B;
            box-shadow: 0 0 0 3px rgba(255, 195, 91, 0.4); 
            outline: none;
        }
        
        /* Fixed Toggle Switch Styling with Smooth Transition */
        .toggle-track {
            background-color: #5A6F82; 
            transition: background-color 0.4s ease;
        }
        .peer:checked + .toggle-track {
            background-color: #E87040; 
        }
        .slider {
            background-color: #F5F1E6; 
            transition: transform 0.4s ease;
        }
        .peer:checked + .toggle-track > .slider {
            transform: translateX(20px); 
        }
        
        /* Custom Range Slider Track (The background track) */
        input[type=range]::-webkit-slider-runnable-track {
            background: #2A3C50;
            height: 8px;
            border-radius: 4px;
        }
        /* Custom Range Slider Thumb (The movable dot) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #FFC35B; /* fiery-core */
            margin-top: -6px;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen antialiased">
    
    <header class="bg-deep-twilight border-b border-subtle-gray/30 p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-fiery-core/90">CHIRPSS</h1>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 sm:p-8">
        <div class="text-center mb-10">
            <h2 class="text-4xl font-extrabold text-soft-horizon mb-2">Imposter</h2>
        </div>

        <div class="bg-deep-twilight/50 p-6 sm:p-8 rounded-xl shadow-2xl border border-subtle-gray/30">
            <form id="imposter-settings-form">
                
                <div class="mb-8">
                    <label for="player-input" class="block text-lg font-semibold mb-2 text-fiery-core">Add Players</label>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="player-input" placeholder="Enter player name" 
                            class="custom-input flex-grow p-3 rounded-lg placeholder-subtle-gray/70" onkeydown="handlePlayerInput(event)">
                        <button type="button" onclick="addPlayer()" class="bg-warm-dusk text-soft-horizon p-3 rounded-lg font-semibold">
                            Add
                        </button>
                    </div>

                    <div id="player-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                        <p class="text-sm text-subtle-gray" id="player-list-placeholder">Add at least 3 players to begin.</p>
                    </div>
                    <p class="text-xs text-subtle-gray mt-1" id="player-count-display">Players: 0 (Min 3)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="imposter-count-slider" class="block text-lg font-semibold mb-2 text-fiery-core">
                            Number of Imposters: <span id="imposter-count-value">1</span>
                        </label>
                        <input type="range" id="imposter-count-slider" min="1" max="5" value="1" 
                               class="w-full h-2 bg-input-bg rounded-lg appearance-none cursor-pointer" 
                               oninput="updateSliderValue('imposter-count-slider', 'imposter-count-value')">
                    </div>

                    <div>
                        <label for="game-time-slider" class="block text-lg font-semibold mb-2 text-fiery-core">
                            Game Time Limit: <span id="game-time-display">5 Minutes</span>
                        </label>
                        <input type="range" id="game-time-slider" min="0.5" max="15" value="5" step="0.5"
                               class="w-full h-2 bg-input-bg rounded-lg appearance-none cursor-pointer"
                               oninput="updateGameTimeDisplay(this.value)">
                    </div>
                </div>

                <div class="mb-8 flex items-center justify-between p-3 bg-input-bg rounded-lg border border-subtle-gray/50">
                    <label for="imposter-hint-toggle" class="block text-lg font-semibold text-fiery-core">
                        Imposter Gets a Hint
                    </label>
                    
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="imposter-hint-toggle" checked class="sr-only peer toggle-switch" onclick="updatePlayerCount()">
                        <div class="w-10 h-5 bg-subtle-gray rounded-full toggle-track">
                            <div class="absolute top-0.5 start-[2px] border border-subtle-gray rounded-full h-4 w-4 bg-soft-horizon slider"></div>
                        </div>
                    </label>
                </div>

                <div class="mb-10">
                    <label class="block text-lg font-semibold mb-3 text-fiery-core">Select Word Categories</label>
                    <div id="categories-container" class="flex flex-wrap gap-3">
                        </div>
                    <p class="text-xs text-subtle-gray mt-2" id="category-count-message">Select one or more categories.</p>
                </div>

                <button type="submit" id="start-game-btn" class="w-full py-4 bg-subtle-gray text-soft-horizon font-extrabold text-xl rounded-xl shadow-lg" disabled>
                    START GAME
                </button>
                
                <p class="text-sm text-subtle-gray mt-6"> Rules: Everyone gets a secret word besides one player (the imposter) who only gets a hint. The imposter must guess the word before the time runs out. If the timer ends, everyone votes. If the imposter isn't voted out, they win. Players take turns saying one word related to the secret word until the timer ends. The youngest player goes first.
                </p>

            </form>
        </div>
        
    </main>

    <script>
        // === REMOVED: EMBEDDED CATEGORY DATA ===

        // === NEW: Define constants for URL and storage keys ===
        const CATEGORY_URL = 'https://chirpss.my.to/Imposter/categories.json';
        const SETTINGS_STORAGE_KEY = 'chirpss_imposter_settings'; 
        const PLAYERS_STORAGE_KEY = 'chirpss_imposter_players';

        let players = [];
        let selectedCategories = [];
        let availableCategories = []; // Will be populated by fetch

        // --- Persistence Helper Function ---
        function getCurrentSettings() {
            const imposterSlider = document.getElementById('imposter-count-slider');
            const timeSlider = document.getElementById('game-time-slider');
            const hintToggle = document.getElementById('imposter-hint-toggle');

            return {
                imposterCount: imposterSlider ? imposterSlider.value : 1,
                gameTimeMinutes: timeSlider ? parseFloat(timeSlider.value) : 5,
                hintEnabled: hintToggle ? hintToggle.checked : true,
                selectedCategories: selectedCategories 
            };
        }

        // --- Persistent Storage Functions ---

        function savePlayersToStorage() {
            localStorage.setItem(PLAYERS_STORAGE_KEY, JSON.stringify(players));
            updatePlayerCount(); 
        }

        function getPlayersFromStorage() {
            const list = localStorage.getItem(PLAYERS_STORAGE_KEY);
            return list ? JSON.parse(list) : [];
        }

        function saveSettingsToStorage(settings) {
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettingsFromStorage() {
            const data = localStorage.getItem(SETTINGS_STORAGE_KEY);
            return data ? JSON.parse(data) : null;
        }

        // --- Setup Logic ---

        function updatePlayerCount() {
            const count = players.length;
            const catCount = selectedCategories.length;
            document.getElementById('player-count-display').textContent = `Players: ${count} (Min 3)`;
            
            // *** CHANGED: Use availableCategories.length instead of the old constant ***
            document.getElementById('category-count-message').textContent = `Selected: ${catCount} of ${availableCategories.length || 0} categories.`;
            
            const startBtn = document.getElementById('start-game-btn');
            
            const isReady = count >= 3 && catCount > 0;
            startBtn.disabled = !isReady;

            if (isReady) {
                startBtn.classList.remove('bg-subtle-gray');
                startBtn.classList.add('bg-warm-dusk');
            } else {
                startBtn.classList.add('bg-subtle-gray');
                startBtn.classList.remove('bg-warm-dusk');
            }

            document.getElementById('player-list-placeholder').style.display = count === 0 ? 'block' : 'none';
            
            saveSettingsToStorage(getCurrentSettings());
        }

        function updateGameTimeDisplay(minutesString) {
            const timeDisplay = document.getElementById('game-time-display');
            const minutes = parseFloat(minutesString);

            if (minutes === 0.5) {
                timeDisplay.textContent = '30 Seconds';
            } else {
                 // Simplified: Just show minutes, e.g., "2.5 Minutes"
                timeDisplay.textContent = `${minutes} Minutes`;
            }
            updatePlayerCount(); // Triggers settings save
        }
        
        function renderPlayers() {
            const listEl = document.getElementById('player-list');
            listEl.innerHTML = '';
            
            if (players.length === 0) {
                listEl.innerHTML = `<p class="text-sm text-subtle-gray" id="player-list-placeholder">Add at least 3 players to begin.</p>`;
            }
            
            players.forEach((name) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'flex justify-between items-center p-2 bg-input-bg rounded-md border border-subtle-gray/50';
                playerEl.innerHTML = `
                    <span>${name}</span>
                    <button type="button" onclick="removePlayer('${name}')" class="text-subtle-gray text-lg font-bold leading-none">
                        &times;
                    </button>
                `;
                listEl.appendChild(playerEl);
            });
        }

        function addPlayer() {
            const input = document.getElementById('player-input');
            let name = input.value.trim();
            
            if (name && !players.includes(name)) {
                if (name.length > 20) {
                    name = name.substring(0, 20) + '...'; 
                }
                players.push(name);
                input.value = '';
                renderPlayers();
                savePlayersToStorage(); // Save and update UI/settings
                document.getElementById('player-list').scrollTop = document.getElementById('player-list').scrollHeight;
            }
        }

        function removePlayer(nameToRemove) {
            players = players.filter(name => name !== nameToRemove);
            renderPlayers();
            savePlayersToStorage(); // Save and update UI/settings
        }

        function handlePlayerInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addPlayer();
            }
        }
        
        function updateSliderValue(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            document.getElementById(valueId).textContent = slider.value;
            updatePlayerCount(); // Triggers settings save
        }

        // *** NEW: Async function to fetch and render categories ***
        async function fetchAndRenderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = `<p class="text-fiery-core">Loading categories...</p>`;

            try {
                const response = await fetch(CATEGORY_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();

                if (!data || !data.c) {
                     throw new Error("Invalid JSON structure.");
                }

                availableCategories = data.c; // Populate the global variable

                renderCategories(); // Now call render
                updatePlayerCount(); // And update the count display

            } catch (error) {
                console.error("Failed to load categories:", error);
                container.innerHTML = `<p class="text-danger-red font-semibold">Error: Could not load word categories. Please try refreshing.</p>`;
                document.getElementById('start-game-btn').disabled = true;
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = ''; 

            if (!availableCategories || availableCategories.length === 0) {
                // This is now mainly a fallback, as the fetch function handles the primary error
                container.innerHTML = `<p class="text-danger-red font-semibold">Error: No categories found.</p>`;
                return;
            }

            availableCategories.forEach(category => {
                const categoryName = category.n; 
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn bg-input-bg text-soft-horizon py-2 px-4 rounded-full border border-subtle-gray/50';
                button.textContent = categoryName;
                
                button.onclick = () => toggleCategory(button, categoryName);
                
                // Apply persistence coloring/selection during rendering
                if (selectedCategories.includes(categoryName)) {
                    button.classList.add('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                    button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
                }
                
                container.appendChild(button);
            });
            // updatePlayerCount() is called by fetchAndRenderCategories after this runs
        }

        function toggleCategory(button, categoryName) {
            const index = selectedCategories.indexOf(categoryName);
            if (index > -1) {
                // Deselect
                selectedCategories.splice(index, 1);
                button.classList.remove('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.add('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            } else {
                // Select
                selectedCategories.push(categoryName);
                button.classList.add('bg-warm-dusk', 'text-deep-twilight', 'border-warm-dusk');
                button.classList.remove('bg-input-bg', 'text-soft-horizon', 'border-subtle-gray/50');
            }
            updatePlayerCount(); // Triggers settings save
        }

        function initializeSettings() {
            const settings = loadSettingsFromStorage();
            
            // 1. Imposters Slider
            const imposterSlider = document.getElementById('imposter-count-slider');
            const imposterCount = settings ? settings.imposterCount || 1 : 1;
            imposterSlider.value = imposterCount;
            document.getElementById('imposter-count-value').textContent = imposterCount;
            imposterSlider.oninput = () => updateSliderValue('imposter-count-slider', 'imposter-count-value');

            // 2. Time Slider
            const timeSlider = document.getElementById('game-time-slider');
            const gameTimeMinutes = settings ? settings.gameTimeMinutes || 5 : 5;
            timeSlider.value = gameTimeMinutes;
            updateGameTimeDisplay(timeSlider.value); // This initial call sets the text display
            timeSlider.oninput = (e) => updateGameTimeDisplay(e.target.value);

            // 3. Hint Toggle
            const hintEnabled = settings ? settings.hintEnabled !== false : true;
            document.getElementById('imposter-hint-toggle').checked = hintEnabled; 
            document.getElementById('imposter-hint-toggle').onclick = updatePlayerCount;

            // 4. Selected Categories (Array used for logic)
            selectedCategories = settings ? settings.selectedCategories || [] : [];
            
            if (!settings) {
                saveSettingsToStorage(getCurrentSettings());
            }
        }

        // --- Initialization and Submit ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load and apply persistent settings to the form controls (Sliders, Toggles, Categories array)
            initializeSettings(); 

            // 2. Load and render players (Updates the global 'players' array and UI list)
            players = getPlayersFromStorage();
            renderPlayers(); // Renders the list

// 3. ***CHANGED: Fetch categories, then render them and update UI***
            fetchAndRenderCategories();
        });

        document.getElementById('imposter-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (players.length < 3) {
                alert("Please add a minimum of 3 players.");
                return;
            }
            if (selectedCategories.length === 0) {
                alert("Please select at least one word category.");
                return;
            }

            const currentSettings = getCurrentSettings();
            
            // Final save just in case
            saveSettingsToStorage(currentSettings);

            // Prepare Game Data for Session
            const finalCategories = availableCategories
                .filter(cat => selectedCategories.includes(cat.n))
                .map(cat => ({ name: cat.n, words: cat.w })); 
            
            // *** NEW: Check if categories actually loaded ***
            if (finalCategories.length === 0 || finalCategories.every(cat => cat.words.length === 0)) {
                alert("Error: No words were loaded from the selected categories. Cannot start game.");
                return;
            }
            
            const gameData = {
                players: players,
                imposterCount: currentSettings.imposterCount,
                gameTimeSeconds: currentSettings.gameTimeMinutes * 60, 
                hintEnabled: currentSettings.hintEnabled,
                categories: finalCategories 
            };

            sessionStorage.setItem('chirpss_imposter_game_data', JSON.stringify(gameData));

            window.location.href = '/Imposter/RevealRole';
        });
    </script>
</body>
</html>
